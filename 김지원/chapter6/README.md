# chapter06. 페이지 압축

디스크에 저장된 파일의 크기는 쿼리의 성능과 백업 및 복구 시간에 영향을 준다.

## 페이지 압축

- 디스크에 저장할 때, 페이지 단위(16KB)로 압축하여 저장
- 펀치 홀 기능으로 디스크의 공간을 효율적으로 사용 할 수 있다.
- 펀치 홀 기능의 한계
    - 운영체제뿐만 아니라 하드웨어 자체에서도 해당 기능을 지원해야 사용 가능하다는 점
    - 아직 파일 시스템 관련 명령어(유틸리티)가 펀치 홀을 지원하지 못한다는 점

## 테이블 압축

- 원본 데이터 페이지의 압축 결과가 목표 크기(KEY_BLOCK_SIZE)보다 작거나 같을 때까지 반복해서 페이지를 스플릿하여 디스크에 저장

### KEY_BLOCK_SIZE 결정

- 4KB, 8KB로 설정하여 샘플 데이터를 저장해보고 적절한지 판단
    - 인덱스별로 압축 실패율(성공횟수/압축횟수)을 계산하여 실패율이 낮은 방향으로 KEY_BLOCK_SIZE 선택
    - 실패율이 높으면 InnoDB 버퍼풀에서 디스크로 기록되기 전에 압축하는 과정이 오래 걸릴 것이라고 판단
- 압축 실패율과 관계없이, 데이터의 변경과 조회의 빈도를 기반으로 압축 여부 판단 고려

### 압축된 페이지의 버퍼 풀 적재 및 사용

- 압축된 테이블의 데이터 페이지를 버퍼 풀에 적재하면 `압축된 상태`와 `압축이 해제된 상태` 2개 버전을 관리
- 압축된 테이블에 대해서 버퍼 풀의 공간을 이중으로 사용함으로써 메모리 낭비
    - LRU 리스트: 압축이 적용되지 않는 테이블의 데이터 페이지, `압축이 적용된 테이블의 압축된 데이터 페이지 관리`
    - Unzip_LRU 리스트: `압축을 해제한 상태의 데이터 페이지 목록 관리`
    - 서버로 유입되는 요청 패턴에 따라 LRU 리스트, Unzip_LRU 리스트의 압축 데이터 비율을 적절하게 유지

### 테이블 압축 관련 설정
- 페이지 압축 시패율을 낮추기 위해 필요한 튜닝 포인트를 제공
  - innodb_cmp_per_index_enabled
  - innodb_compression_level
  - innodb_compression_failure_threshold_pct, innodb_compression_pad_pct_max
  - innodb_log_compression_pages
